<mat-card style="margin: 24px;">
  <mat-card-header>
    <mat-card-title>Criar Novo Pedido</mat-card-title>
  </mat-card-header>
  <mat-card-content>
    <form [formGroup]="orderForm" (ngSubmit)="onSubmit()" class="order-form">
      <div class="section">
        <h3 class="mat-title-medium">1. Cliente</h3>
        <mat-form-field appearance="outline" style="width: 100%;">
          <mat-label>Buscar Cliente</mat-label>
          <input type="text"
                 matInput
                 [formControl]="customerCtrl"
                 [matAutocomplete]="autoCustomer"
                 required>
          <mat-autocomplete #autoCustomer="matAutocomplete" [displayWith]="displayCustomer" (optionSelected)="onCustomerSelected($event)">
            <mat-option *ngFor="let customer of filteredCustomers$ | async" [value]="customer">
              {{customer.name}}
            </mat-option>
          </mat-autocomplete>
        </mat-form-field>
      </div>
      <div class="section">
        <h3 class="mat-title-medium">2. Adicionar Produto ao Pedido</h3>
        <div class="add-product-container">
          <mat-form-field appearance="outline" class="product-search-field">
            <mat-label>Buscar Produto</mat-label>
            <input type="text"
                   matInput
                   [formControl]="productCtrl"
                   [matAutocomplete]="autoProduct">
            <mat-autocomplete #autoProduct="matAutocomplete" [displayWith]="displayProduct" (optionSelected)="onProductSelected($event)">
              <mat-option *ngFor="let product of filteredProducts$ | async" [value]="product">
                {{product.name}} (Estoque: {{product.stockQty}})
              </mat-option>
            </mat-autocomplete>
          </mat-form-field>

          <mat-form-field appearance="outline" class="quantity-field">
            <mat-label>Qtde</mat-label>
            <input type="number" matInput [formControl]="quantityCtrl">
          </mat-form-field>

          <button mat-flat-button color="primary" type="button" (click)="addProduct()" [disabled]="!selectedProduct || quantityCtrl.invalid" class="add-button">
            <mat-icon>add</mat-icon>
            Adicionar
          </button>
        </div>
      </div>
      <div class="section" *ngIf="items.length > 0">
        <h3 class="mat-title-medium">3. Itens do Pedido</h3>
        <table mat-table [dataSource]="itemsDataSource" class="mat-elevation-z8">
          <ng-container matColumnDef="productName">
            <th mat-header-cell *matHeaderCellDef> Produto </th>
            <td mat-cell *matCellDef="let item"> {{ getItemFormGroup(item).get('productName')?.value }} </td>
          </ng-container>
          <ng-container matColumnDef="quantity">
            <th mat-header-cell *matHeaderCellDef> Quantidade </th>
            <td mat-cell *matCellDef="let item"> {{ getItemFormGroup(item).get('quantity')?.value }} </td>
          </ng-container>
          <ng-container matColumnDef="unitPrice">
            <th mat-header-cell *matHeaderCellDef> Pre√ßo Unit. </th>
            <td mat-cell *matCellDef="let item"> {{ getItemFormGroup(item).get('unitPrice')?.value | currency:'BRL' }} </td>
          </ng-container>
          <ng-container matColumnDef="lineTotal">
            <th mat-header-cell *matHeaderCellDef> Total </th>
            <td mat-cell *matCellDef="let item">
              {{ (getItemFormGroup(item).get('quantity')?.value * getItemFormGroup(item).get('unitPrice')?.value) | currency:'BRL' }}
            </td>
          </ng-container>
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef></th>
            <td mat-cell *matCellDef="let item; let i = index">
              <button mat-icon-button color="warn" (click)="removeItem(i)" aria-label="Remover item">
                <mat-icon>delete</mat-icon>
              </button>
            </td>
          </ng-container>
          <tr mat-header-row *matHeaderRowDef="itemDisplayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: itemDisplayedColumns;"></tr>
        </table>
      </div>

      <div class="total-container" *ngIf="items.length > 0">
        <h2 class="mat-headline-6">Total do Pedido: {{ getTotalCost() | currency:'BRL' }}</h2>
      </div>

    </form>
  </mat-card-content>
  <mat-card-actions align="end" style="padding: 16px;">
    <button mat-button routerLink="/products" type="button">Cancelar</button>
    <button mat-flat-button color="primary" (click)="onSubmit()" [disabled]="orderForm.invalid">
      Finalizar Pedido
    </button>
  </mat-card-actions>
</mat-card>